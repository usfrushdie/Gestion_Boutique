#include<stdio.h>
#include<stdlib.h>
#include<math.h>
#include<string.h>
#include<malloc.h>
#include"Produit.h"

    
void add_fproduit(listeP *teteP)
	{
		FILE *fp;
		fp = fopen("Produit.txt","w+");
		if(fp==NULL)
			{
				printf("Le fichier ne peut pas etre ouvert \n");
				return;
			}
		if(teteP==NULL)	return;
		listeP *C;
		C=teteP;
		while(C!=NULL)
			{
				fprintf(fp,"%d\n%s\n%.2f\n",C->X.IDProduit,C->X.nomproduit,C->X.prix);
				C=C->s;
			}
        fclose(fp);
	}

produit creation_produit(produit X)
    {
    	getchar();
        printf("\tDescription du Produit: ");
        gets(X.nomproduit);
        printf("\tPrix: ");
        scanf("%f",&X.prix);
        printf("\tNombre de pieces disponibles dans le stock: \n");
        	printf("\t\tSmall: ");
        	scanf("%d",&X.taille.S);
        	printf("\t\tMedium: ");
        	scanf("%d",&X.taille.M);
			printf("\t\tLarge: ");
			scanf("%d",&X.taille.L);
		printf("\tNombre de pieces selon la categorie des clients: \n");
        	printf("\t\tHommes: ");
        	scanf("%d",&X.M_F.M);
        	printf("\t\tFemmes: ");
        	scanf("%d",&X.M_F.F);
		return X;	
    }
    
listeP *ajout_produit(listeP *teteP, produit A)
	{
		listeP *N;
		listeP *C=teteP;
		N=(listeP*)malloc(sizeof(listeP));
		N->s=NULL;
		N->X=A;
		N->X.IDProduit=0;
		if(teteP==NULL)	
			{
				teteP=N;
				teteP->X.IDProduit=1;
			}
		else
			{
				while(C->s!=NULL)
					{
						C=C->s;
						N->X.IDProduit++;
					}
				C->s=N;
				N->X.IDProduit=C->X.IDProduit+1;
			}
		return teteP;
	}
    
listeP *supp_produit(int IDP, listeP *teteP)
	{
		if(teteP==NULL)		
			{
				printf("Vous n'avez aucun produit a supprimer !!\n");
				return teteP;
			}
		else
			{
				listeP *C;
				C=teteP;
				while(C->s->X.IDProduit!=IDP)	C=C->s;
				listeP *P;
				P=C->s;
				C->s=P->s;
				free(P);
			}
		return teteP;
	}
    
int max_long_titre(listeP *teteP)
	{
		int M=strlen(teteP->X.nomproduit);
		listeP *C;
		C=teteP;
		while(C!=NULL)
			{
				if(M<strlen(C->X.nomproduit))	M=strlen(C->X.nomproduit);
				C=C->s;
			}
		return M;
	}
	
int max_ID(listeP *teteP)
	{
		return teteP->X.IDProduit;
	}	
	
void afficherP(listeP *teteP)
	{
		int M=max_long_titre(teteP), N=max_ID(teteP), K;
		M=M+10;
		int i;
		printf("\t");
		printf("ID:");		for(i=1;i<=5;i++)	printf(" ");
		printf("Titre:");	for(i=7;i<=M;i++)	printf(" ");
		printf("Prix:\n");
		listeP *C=teteP;
		while(C!=NULL)
			{
				printf("\t");
				if(C->X.IDProduit<10)	K=1;
				else if(C->X.IDProduit<100)	K=2;
				else if(C->X.IDProduit<1000)	K=3;
				printf("%d",C->X.IDProduit); 	for(i=1;i<=8-K;i++)	printf(" ");
				printf("%s",C->X.nomproduit);	for(i=1;i<=M-strlen(C->X.nomproduit);i++)	printf(" ");
				printf("%.2f\n",C->X.prix);
				C=C->s;
			}
		return;
	}
	
listeP *modifyP(listeP *teteP, int IDP)
	{
		if(teteP==NULL)
			{
				printf("Vous n'avez aucun produit a modifier !!");
				return teteP;
			}
		listeP *C=teteP;
		while(C->s->X.IDProduit!=IDP)	C=C->s;
        printf("Mise a jour des donnees du produit Nr %d !! \n",IDP);
        C->X=creation_produit(C->X);
		
	}    

int listeMenuP(listeP *teteP)
	{
		int choix;
		printf("Les Produits de Votre Boutique ! \n\n");
		afficherP(teteP);
		printf("\n\n");
        printf("\t");	printf("1- Ajouter un produit\n");
        printf("\t");	printf("2- Supprimer un produit\n");
        printf("\t");	printf("3- Modifier un produit\n");
        printf("\t");	printf("4- Enregistrer les modifications\n");
		printf("\n\tChoisissez le numero du choix que vous voulez (N'importe quelle valeur pour sortir du programme): ");
        scanf("%d",&choix);
        system("cls");
        if((choix<1)||(choix>4))    return 0;
        return choix;
	}
	
listeP *file_to_liste(listeP *teteP)
	{
		produit X;
		FILE *fp;
		fp = fopen("Produit.txt","r+");
		if(fp==NULL)
			{
				printf("Le fichier ne peut pas etre ouvert \n");
				return;
			}
		while(1)
			{
				fscanf(fp,"%s\n%f\n",&X.nomproduit,&X.prix);
				teteP=ajout_produit(teteP,X);
				if(feof(fp))	break;
			}
		fclose(fp);
		return teteP;
	}

void MenuP()
	{
		produit X;
		listeP *teteP=NULL;
		int C,IDP;
		teteP=file_to_liste(teteP);
		do
			{
//			system("cls");
			C=listeMenuP(teteP);
			if(C==1)	
				{
					X=creation_produit(X);
					teteP=ajout_produit(teteP,X);
					printf("Le produit est ajoute !\n");
				}
			else if(C==2)
				{
					do
						{
							printf("Saisie l'ID du produit que vous voulez supprimer : ");	scanf("%d",&IDP);
						}	while((IDP<1)||(IDP>teteP->X.IDProduit));
					teteP=supp_produit(IDP,teteP);
					printf("Le produit est supprime !\n");
				}
			else if(C==3)
				{
					do
						{
							printf("Saisie l'ID du produit que vous voulez modifier : ");	scanf("%d",&IDP);
						}	while((IDP<1)||(IDP>teteP->X.IDProduit));				
					modifyP(teteP,IDP);
					printf("Le produit est modifie !\n");
				}
			else if(C==4)
				{
					add_fproduit(teteP);
					printf("Tous les produits sont enregistres !\n");
				}
			}	while((C<5)&&(C>0));
	}





















    